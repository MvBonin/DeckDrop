name: Build Binary + AppImage

on:
  push:
    branches:
      - master
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 \
                                  patchelf \
                                  wget

      - name: Build Binary
        run: |
          cargo build --release --package deckdrop-ui

      - name: Prepare AppDir
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          cp target/release/deckdrop AppDir/usr/bin/deckdrop

          # Create desktop file - appimagetool expects it to match the AppImage name (DeckDrop)
          cat > AppDir/usr/share/applications/DeckDrop.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=DeckDrop
          Comment=Local P2P game sharing for Steam Deck
          Exec=deckdrop
          Icon=deckdrop
          Terminal=false
          Categories=Game;Utility;
          StartupNotify=true
          EOF

          # Also create in AppDir root with both names (some appimagetool versions check here first)
          cp AppDir/usr/share/applications/DeckDrop.desktop AppDir/DeckDrop.desktop
          cp AppDir/usr/share/applications/DeckDrop.desktop AppDir/deckdrop.desktop

          # Copy icon - appimagetool looks for it in AppDir root first
          if [ -f assets/deckdrop.png ]; then
            # Copy to AppDir root (appimagetool checks here first)
            cp assets/deckdrop.png AppDir/deckdrop.png
            # Also copy to standard location
            cp assets/deckdrop.png AppDir/usr/share/icons/hicolor/256x256/apps/deckdrop.png
          else
            echo "Warning: assets/deckdrop.png not found, creating placeholder"
            # Create a simple placeholder icon if missing
            convert -size 256x256 xc:blue -pointsize 72 -fill white -gravity center -annotate +0+0 "DD" AppDir/deckdrop.png 2>/dev/null || \
            echo "Note: ImageMagick not available, skipping placeholder icon"
          fi

          # Create AppRun script (required for AppImage)
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF="$(readlink -f "${0}")"
          HERE="$(dirname "${SELF}")"
          exec "${HERE}/usr/bin/deckdrop" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Verify desktop file exists
          ls -la AppDir/usr/share/applications/
          ls -la AppDir/

      - name: Download appimagetool
        run: |
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Build AppImage
        run: |
          ./appimagetool-x86_64.AppImage AppDir DeckDrop-x86_64.AppImage

      - name: Upload binary (always)
        uses: actions/upload-artifact@v4
        with:
          name: DeckDrop-Binary
          path: target/release/deckdrop

      - name: Upload AppImage (always)
        uses: actions/upload-artifact@v4
        with:
          name: DeckDrop-AppImage
          path: DeckDrop-x86_64.AppImage

      - name: Upload to GitHub Release (only if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            target/release/deckdrop
            DeckDrop-x86_64.AppImage